<?xml version="1.0" encoding="UTF-8"?>

<?include ..\Includes\Variables.wxi ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Fragment>

    <?foreach ide in VS2010;VS2012;VS2013 ?>

    <PropertyRef Id="$(var.ide)_ROOT_FOLDER" />

    <ComponentGroup Id="CompGroup_$(var.ide)Extension">
      <ComponentRef Id="Comp_NemerleCompilerUtils" />
      <ComponentRef Id="Comp_NemerleVisualStudio" />
      <ComponentRef Id="Comp_WpfHint" />
      <ComponentRef Id="Comp_$(var.ide)_Resources" />
      <ComponentRef Id="Comp_$(var.ide)_SnippetsIndex"/>
      <ComponentRef Id="Comp_$(var.ide)_Snippets"/>
      <ComponentRef Id="Comp_$(var.ide)_ItemTemplates"/>
      <ComponentRef Id="Comp_$(var.ide)_ProjectTemplates"/>
    </ComponentGroup>

    <DirectoryRef Id="TARGETDIR">
      <Directory Id="$(var.ide)_ROOT_FOLDER">
        <Directory Id="$(var.ide)_Common7_Folder" Name="Common7">
          <Directory Id="$(var.ide)_IDE_Folder" Name="IDE">
            <Directory Id="$(var.ide)_Extensions_Folder" Name="Extensions">
              <Directory Id="$(var.ide)_ExtensionManufacturer_Folder" Name="$(var.Manufacturer)">
                <Directory Id="$(var.ide)_ExtensionName_Folder" Name="$(var.ProductName)">
                  <Directory Id="$(var.ide)_ExtensionVersion_Folder" Name="$(var.ProductVersion)">
                    <Directory Id="$(var.ide)_Resources_Folder" Name="Resources" />
                    <Directory Id="$(var.ide)_CodeSnippets_Folder" Name="CodeSnippets">
                      <Directory Id="$(var.ide)_CodeSnippets_Snippets_Folder" Name="Snippets" />
                    </Directory>
                    <Directory Id="$(var.ide)_ItemTemplates_Folder" Name="ItemTemplates">
                      <Directory Id="$(var.ide)_ItemTemplates_Nemerle_Folder" Name="Nemerle" />
                    </Directory>
                    <Directory Id="$(var.ide)_ProjectTemplates_Folder" Name="ProjectTemplates">
                      <Directory Id="$(var.ide)_ProjectTemplates_Nemerle_Folder" Name="Nemerle" />
                    </Directory>
                  </Directory>
                </Directory>
              </Directory>
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </DirectoryRef>

    <?endforeach?>

    <!-- Common IDE components -->

    <DirectoryRef Id="Dir_Nver" FileSource="$(var.DistPath)\vs-plugin\">
      <Component Id="Comp_NemerleCompilerUtils" DiskId="1" Guid="$(var.Comp_NemerleCompilerUtils_Guid)">
        <File Id="File_Nemerle.Compiler.Utils.dll" Name="Nemerle.Compiler.Utils.dll" />
<?if $(var.Configuration) = "Debug" ?>
        <File Id="File_Nemerle.Compiler.Utils.pdb" Name="Nemerle.Compiler.Utils.pdb" />
<?endif?>
      </Component>
      <Component Id="Comp_NemerleVisualStudio" DiskId="1" Guid="$(var.Comp_NemerleVisualStudio_Guid)">
        <File Id="File_Nemerle.VisualStudio.dll" Name="Nemerle.VisualStudio.dll" />
<?if $(var.Configuration) = "Debug" ?>
        <File Id="File_Nemerle.VisualStudio.pdb" Name="Nemerle.VisualStudio.pdb" />
<?endif?>
      </Component>
      <Component Id="Comp_WpfHint" DiskId="1" Guid="$(var.Comp_WpfHint_Guid)">
        <File Id="File_WpfHint.dll" Name="WpfHint.dll" />
<?if $(var.Configuration) = "Debug" ?>
        <File Id="File_WpfHint.pdb" Name="WpfHint.pdb" />
<?endif?>
      </Component>
    </DirectoryRef>

<? define PackageSectionsToPatch =
  $RootKey$\Packages\{cf7296f1-47e5-4915-83a0-8c44961f0981};
  $RootKey$\CLSID\{a8b57672-dc5e-4915-a31a-b1c428b29fe1};
  $RootKey$\CLSID\{99a7dac8-2fee-4e25-8339-dd716a811524};
  $RootKey$\CLSID\{edcc3b7e-0bad-11db-bc1a-00112fde8b61};
  $RootKey$\CLSID\{edcc3b89-0bad-11db-bc1a-00112fde8b61};
  $RootKey$\CLSID\{edcc3b88-0bad-11db-bc1a-00112fde8b61} ?>

    <!-- VS2010 Specific components -->

    <DirectoryRef Id="VS2010_ExtensionVersion_Folder" FileSource="$(var.DistPath)\vs-plugin">
      <Component Id="Comp_VS2010Extension" DiskId="1" Guid="$(var.Comp_VS2010Extension_Guid)">
        <File Id="File_VS2010_extension.vsixmanifest" Name="extension.vsixmanifest" />
        <util:XmlFile Id="Xml_VS2010_extension.vsixmanifest_1" File="[VS2010_ExtensionVersion_Folder]extension.vsixmanifest" SelectionLanguage="XPath"
                      Action="setValue" ElementPath="//*[\[]local-name()='InstalledByMsi'[\]]" Value="true" />
        <util:XmlFile Id="Xml_VS2010_extension.vsixmanifest_2" File="[VS2010_ExtensionVersion_Folder]extension.vsixmanifest" SelectionLanguage="XPath"
                      Action="setValue" ElementPath="//*[\[]local-name()='MefComponent' and contains(text(), 'Nemerle.VisualStudio.dll')[\]]" Value="[INSTALLFOLDER]Nemerle.VisualStudio.dll" />

        <File Id="File_VS2010_Nemerle.VisualStudio.pkgdef" Name="Nemerle.VisualStudio.pkgdef" />
        <?foreach section in $(var.PackageSectionsToPatch) ?>
        <IniFile Id="Ini_VS2010_Nemerle.VisualStudio.pkgdef_$(var.section)" Name="Nemerle.VisualStudio.pkgdef" Directory="VS2010_ExtensionVersion_Folder"
                 Action="addLine" Section="$(var.section)" Key="&quot;CodeBase&quot;" Value="&quot;[INSTALLFOLDER]Nemerle.VisualStudio.dll&quot;" />
        <?endforeach?>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2010_Resources_Folder" FileSource="$(var.DistPath)\vs-plugin">
      <Component Id="Comp_VS2010_Resources" DiskId="1" Guid="$(var.Comp_VS2010ExtensionResources_Guid)">
        <File Id="File_Nemerle.ico" Name="Nemerle.ico" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2010_CodeSnippets_Folder" FileSource="$(var.DistPath)\vs-plugin\CodeSnippets">
      <Component Id="Comp_VS2010_SnippetsIndex" DiskId="1" Guid="$(var.Comp_VS2010ExtensionCodeSnippets_Guid)">
        <File Id="File_SnippetsIndex.xml" Name="SnippetsIndex.xml" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2010_CodeSnippets_Snippets_Folder" FileSource="$(var.DistPath)\vs-plugin\CodeSnippets\Snippets">
      <Component Id="Comp_VS2010_Snippets" DiskId="1" Guid="$(var.Comp_VS2010ExtensionSnippets_Guid)">
        <?include VsSnippets.wxi ?>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2010_ItemTemplates_Nemerle_Folder" FileSource="$(var.DistPath)\vs-plugin\ItemTemplates\Nemerle">
      <Component Id="Comp_VS2010_ItemTemplates" DiskId="1" Guid="$(var.Comp_VS2010ExtensionItemTemplates_Guid)">
        <?include VsItemTemplates.wxi ?>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2010_ProjectTemplates_Nemerle_Folder" FileSource="$(var.DistPath)\vs-plugin\ProjectTemplates\Nemerle">
      <Component Id="Comp_VS2010_ProjectTemplates" DiskId="1" Guid="$(var.Comp_VS2010ExtensionProjectTemplates_Guid)">
        <?include VsProjectTemplates.wxi ?>
      </Component>
    </DirectoryRef>


    <!-- VS2012 Specific components -->

    <DirectoryRef Id="VS2012_ExtensionVersion_Folder" FileSource="$(var.DistPath)\vs-plugin">
      <Component Id="Comp_VS2012Extension" DiskId="1" Guid="$(var.Comp_VS2012Extension_Guid)">
        <File Id="File_VS2012_extension.vsixmanifest" Name="extension.vsixmanifest" />
        <util:XmlFile Id="Xml_VS2012_extension.vsixmanifest_1" File="[VS2012_ExtensionVersion_Folder]extension.vsixmanifest" SelectionLanguage="XPath"
                      Action="setValue" ElementPath="//*[\[]local-name()='InstalledByMsi'[\]]" Value="true" />
        <util:XmlFile Id="Xml_VS2012_extension.vsixmanifest_2" File="[VS2012_ExtensionVersion_Folder]extension.vsixmanifest" SelectionLanguage="XPath"
                      Action="setValue" ElementPath="//*[\[]local-name()='MefComponent' and contains(text(), 'Nemerle.VisualStudio.dll')[\]]" Value="[INSTALLFOLDER]Nemerle.VisualStudio.dll" />

        <File Id="File_VS2012_Nemerle.VisualStudio.pkgdef" Name="Nemerle.VisualStudio.pkgdef" />
        <?foreach section in $(var.PackageSectionsToPatch) ?>
        <IniFile Id="Ini_VS2012_Nemerle.VisualStudio.pkgdef_$(var.section)" Name="Nemerle.VisualStudio.pkgdef" Directory="VS2012_ExtensionVersion_Folder"
                 Action="addLine" Section="$(var.section)" Key="&quot;CodeBase&quot;" Value="&quot;[INSTALLFOLDER]Nemerle.VisualStudio.dll&quot;" />
        <?endforeach?>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2012_Resources_Folder" FileSource="$(var.DistPath)\vs-plugin">
      <Component Id="Comp_VS2012_Resources" DiskId="1" Guid="$(var.Comp_VS2012ExtensionResources_Guid)">
        <File Id="File_Nemerle.ico" Name="Nemerle.ico" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2012_CodeSnippets_Folder" FileSource="$(var.DistPath)\vs-plugin\CodeSnippets">
      <Component Id="Comp_VS2012_SnippetsIndex" DiskId="1" Guid="$(var.Comp_VS2012ExtensionCodeSnippets_Guid)">
        <File Id="File_SnippetsIndex.xml" Name="SnippetsIndex.xml" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2012_CodeSnippets_Snippets_Folder" FileSource="$(var.DistPath)\vs-plugin\CodeSnippets\Snippets">
      <Component Id="Comp_VS2012_Snippets" DiskId="1" Guid="$(var.Comp_VS2012ExtensionSnippets_Guid)">
        <?include VsSnippets.wxi ?>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2012_ItemTemplates_Nemerle_Folder" FileSource="$(var.DistPath)\vs-plugin\ItemTemplates\Nemerle">
      <Component Id="Comp_VS2012_ItemTemplates" DiskId="1" Guid="$(var.Comp_VS2012ExtensionItemTemplates_Guid)">
        <?include VsItemTemplates.wxi ?>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2012_ProjectTemplates_Nemerle_Folder" FileSource="$(var.DistPath)\vs-plugin\ProjectTemplates\Nemerle">
      <Component Id="Comp_VS2012_ProjectTemplates" DiskId="1" Guid="$(var.Comp_VS2012ExtensionProjectTemplates_Guid)">
        <?include VsProjectTemplates.wxi ?>
      </Component>
    </DirectoryRef>

    <!-- VS2013 Specific components -->

    <DirectoryRef Id="VS2013_ExtensionVersion_Folder" FileSource="$(var.DistPath)\vs-plugin">
      <Component Id="Comp_VS2013Extension" DiskId="1" Guid="$(var.Comp_VS2013Extension_Guid)">
        <File Id="File_VS2013_extension.vsixmanifest" Name="extension.vsixmanifest" />
        <util:XmlFile Id="Xml_VS2013_extension.vsixmanifest_1" File="[VS2013_ExtensionVersion_Folder]extension.vsixmanifest" SelectionLanguage="XPath"
                      Action="setValue" ElementPath="//*[\[]local-name()='InstalledByMsi'[\]]" Value="true" />
        <util:XmlFile Id="Xml_VS2013_extension.vsixmanifest_2" File="[VS2013_ExtensionVersion_Folder]extension.vsixmanifest" SelectionLanguage="XPath"
                      Action="setValue" ElementPath="//*[\[]local-name()='MefComponent' and contains(text(), 'Nemerle.VisualStudio.dll')[\]]" Value="[INSTALLFOLDER]Nemerle.VisualStudio.dll" />

        <File Id="File_VS2013_Nemerle.VisualStudio.pkgdef" Name="Nemerle.VisualStudio.pkgdef" />
        <?foreach section in $(var.PackageSectionsToPatch) ?>
        <IniFile Id="Ini_VS2013_Nemerle.VisualStudio.pkgdef_$(var.section)" Name="Nemerle.VisualStudio.pkgdef" Directory="VS2013_ExtensionVersion_Folder"
                 Action="addLine" Section="$(var.section)" Key="&quot;CodeBase&quot;" Value="&quot;[INSTALLFOLDER]Nemerle.VisualStudio.dll&quot;" />
        <?endforeach?>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2013_Resources_Folder" FileSource="$(var.DistPath)\vs-plugin">
      <Component Id="Comp_VS2013_Resources" DiskId="1" Guid="$(var.Comp_VS2013ExtensionResources_Guid)">
        <File Id="File_Nemerle.ico" Name="Nemerle.ico" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2013_CodeSnippets_Folder" FileSource="$(var.DistPath)\vs-plugin\CodeSnippets">
      <Component Id="Comp_VS2013_SnippetsIndex" DiskId="1" Guid="$(var.Comp_VS2013ExtensionCodeSnippets_Guid)">
        <File Id="File_SnippetsIndex.xml" Name="SnippetsIndex.xml" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2013_CodeSnippets_Snippets_Folder" FileSource="$(var.DistPath)\vs-plugin\CodeSnippets\Snippets">
      <Component Id="Comp_VS2013_Snippets" DiskId="1" Guid="$(var.Comp_VS2013ExtensionSnippets_Guid)">
        <?include VsSnippets.wxi ?>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2013_ItemTemplates_Nemerle_Folder" FileSource="$(var.DistPath)\vs-plugin\ItemTemplates\Nemerle">
      <Component Id="Comp_VS2013_ItemTemplates" DiskId="1" Guid="$(var.Comp_VS2013ExtensionItemTemplates_Guid)">
        <?include VsItemTemplates.wxi ?>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="VS2013_ProjectTemplates_Nemerle_Folder" FileSource="$(var.DistPath)\vs-plugin\ProjectTemplates\Nemerle">
      <Component Id="Comp_VS2013_ProjectTemplates" DiskId="1" Guid="$(var.Comp_VS2013ExtensionProjectTemplates_Guid)">
        <?include VsProjectTemplates.wxi ?>
      </Component>
    </DirectoryRef>

  </Fragment>
</Wix>